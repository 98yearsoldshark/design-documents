# 社区端后端系统详细设计

## 1、系统概述

### 1.1、系统简介
社区端后端系统是基于Node.js和Express框架开发的Web服务器，为教育平台提供社区互动功能，支持用户交流、角色管理、内容分享等功能，连接教师端和学生端，为用户提供丰富的社交和知识共享体验。

### 1.2、术语表  
| 序号 | 术语或缩略语 | 说明性定义                                    |
| ---- | ------------ | --------------------------------------------- |
| 1    | Express      | 基于Node.js的Web应用框架，提供HTTP服务器功能  |
| 2    | JWT          | JSON Web Token，用于用户身份验证的开放标准    |
| 3    | REST API     | 遵循REST架构风格的应用程序接口                |
| 4    | MySQL        | 关系型数据库管理系统                          |
| 5    | RBAC         | Role-Based Access Control，基于角色的访问控制 |

### 1.3、系统运行环境 
- **硬件平台**：标准服务器或云服务器
- **操作系统**：Linux、Windows或macOS
- **运行环境**：Node.js 18.x或更高版本
- **数据库系统**：MySQL 8.x
- **网络协议**：HTTP/HTTPS
- **端口**：3003

### 1.4、开发环境 
- **开发语言**：JavaScript (Node.js)
- **Web框架**：Express 4.x
- **数据库驱动**：mysql2 3.x
- **认证库**：jsonwebtoken 9.x
- **版本控制**：Git
- **代码编辑器**：VS Code或其他现代IDE

## 2、数据结构说明

### 2.1、常量
- **配置常量**
  - `COMMUNITY_JWT_SECRET`：JWT签名密钥
  - `COMMUNITY_PORT`：服务器端口，默认为3003
  - `COMMUNITY_API_PREFIX`：API路径前缀，默认为'/api/community'

- **角色常量**
  - `ROLES`：系统预定义角色，包括'admin', 'suprem-admin', 'teacher', 'assistant', 'student'

### 2.2、变量
- **全局变量**
  - `app`：Express应用实例
  - `pool`：MySQL连接池

### 2.3、数据结构

#### 数据库表结构
1. **用户角色映射表 (user_role_mapping)**
```
用户角色映射表存储用户ID(学生或教师)、角色类型和创建时间信息，主要字段包括id、student_user_id、teacher_user_id和role等。
```

2. **帖子表 (posts)**
```
帖子表存储社区内容，包含id、标题、内容、作者ID、作者类型、分类、创建时间、更新时间、浏览量、点赞数和状态等字段。
```

3. **评论表 (comments)**
```
评论表存储帖子评论，主要字段包括id、帖子ID、内容、作者ID、作者类型、父评论ID、创建时间和点赞数等，支持多级评论结构。
```

## 3、模块设计  

### 3.1、软件结构  

#### 系统架构图
```
backend/community-server/
├── server.js                    # 服务器入口文件
├── routes/                      # 路由模块
│   ├── postRoutes.js            # 帖子路由
│   ├── commentRoutes.js         # 评论路由
│   ├── interactionRoutes.js     # 互动路由
│   ├── friendshipRoutes.js      # 好友关系路由
│   ├── userRoutes.js            # 用户管理路由
│   └── roleRoutes.js            # 角色管理路由
├── db/                          # 数据库相关
│   ├── initDatabase.js          # 数据库初始化
│   └── userRoleMapping.js       # 用户角色映射管理
```

### 3.2、功能设计说明 
系统采用模块化设计，围绕社区核心功能组织路由和控制逻辑。实现基于角色的访问控制（RBAC），确保用户只能访问有权限的功能。系统能与教师端和学生端无缝集成，使用共享的认证机制和用户角色映射，实现教师和学生的跨系统互动。

### 3.3、用户角色管理模块

#### 3.3.1、设计图
```
用户角色管理模块
    ├── 角色路由(roleRoutes.js)
    │   ├── GET /roles/user/:userId - 获取用户角色
    │   ├── POST /roles/assign - 分配角色
    │   ├── DELETE /roles/revoke - 撤销角色
    │   └── GET /roles/check-suprem-admin - 检查最高管理员
    └── 用户角色映射(userRoleMapping.js)
        ├── 初始化映射表
        ├── 创建角色映射
        ├── 查询用户角色
        └── 管理权限检查
```

#### 3.3.2、功能描述
用户角色管理模块负责维护用户角色和权限，支持教师-学生账号关联，为整个社区系统提供统一的权限控制机制。该模块实现RBAC模型，使系统功能访问精确到角色级别。

#### 3.3.3、输入数据
- 用户ID：教师ID或学生ID
- 用户类型：标识是教师还是学生
- 角色分配请求：用户ID、角色名称

#### 3.3.4、输出数据
- 用户角色列表
- 权限检查结果
- 操作状态和消息

#### 3.3.5、数据设计
使用user_role_mapping表存储用户角色关联（见2.3节）

#### 3.3.6、算法和流程
1. **获取用户角色流程**:
   - 验证请求参数
   - 查询用户角色映射
   - 解析角色和对应权限
   - 返回结果

2. **分配角色流程**:
   - 验证请求数据和授权
   - 检查角色有效性
   - 创建或更新角色映射
   - 返回操作结果

#### 3.3.7、函数说明
- **getUserRoles(req, res)**
  - 功能：获取用户角色列表
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON角色列表)

- **assignRole(req, res)**
  - 功能：分配角色给用户
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON操作结果)

#### 3.3.8、全局数据结构与该模块的关系
该模块管理user_role_mapping表，与身份验证和权限控制密切相关，影响所有需要权限验证的功能。

#### 3.3.9、子模块设计

##### 3.3.9.1、角色定义与权限映射子模块

###### 设计图
```
角色定义与权限映射子模块
    ├── 角色定义
    │   ├── 角色类型枚举
    │   ├── 角色权限映射表
    │   └── 角色继承关系
    └── 权限项管理
        ├── 权限项定义
        ├── 权限组管理
        └── 权限检查算法
```

###### 功能描述
角色定义与权限映射子模块负责定义系统中的角色类型、每种角色拥有的权限集合，以及角色之间的继承关系。通过配置化的方式管理权限，支持灵活调整角色权限而无需修改代码。

###### 数据设计
```
使用JavaScript对象定义角色权限映射，如学生角色可查看帖子和创建评论，教师角色具有更多权限，管理员拥有全部权限。支持权限继承和分组管理。
```

###### 算法和流程
- **角色权限解析流程**：
  - 获取用户角色
  - 查询角色权限映射
  - 处理角色继承（如果有）
  - 构建完整权限集合
  - 返回权限列表

###### 函数说明
- **getPermissionsByRole(role)**：根据角色获取对应的权限列表
- **hasPermission(role, permission)**：检查角色是否拥有特定权限

##### 3.3.9.2、用户-角色分配子模块

###### 设计图
```
用户-角色分配子模块
    ├── 角色分配管理
    │   ├── 分配角色
    │   ├── 撤销角色
    │   └── 角色变更记录
    └── 用户角色查询
        ├── 获取用户角色
        ├── 查询角色用户
        └── 角色统计
```

###### 功能描述
用户-角色分配子模块管理用户与角色之间的关联关系，提供分配角色、撤销角色、查询用户角色等功能，同时记录角色变更历史，支持角色变更审计。

###### 数据设计
```
角色变更记录表存储用户角色变更历史，包含用户ID、用户类型、旧角色、新角色、操作人ID、变更原因和时间等字段，支持角色变更的审计和回溯。
```

###### 算法和流程
- **角色分配流程**：
  - 验证操作用户权限
  - 验证目标用户和角色有效性
  - 检查角色限制条件
  - 更新用户角色映射
  - 记录角色变更日志
  - 返回操作结果

###### 函数说明
- **assignRoleToUser(userId, userType, role, changedBy, reason)**：分配角色给用户
- **revokeRoleFromUser(userId, userType, changedBy, reason)**：从用户撤销角色

##### 3.3.9.3、权限验证子模块

###### 设计图
```
权限验证子模块
    ├── 中间件
    │   ├── 用户认证中间件
    │   ├── 权限检查中间件
    │   └── 角色验证中间件
    └── 验证策略
        ├── 权限缓存
        ├── 验证算法
        └── 权限拒绝处理
```

###### 功能描述
权限验证子模块提供API请求的权限验证功能，通过中间件方式集成到路由系统，确保只有拥有适当权限的用户才能访问受保护的资源。支持权限缓存以提高性能，同时提供灵活的验证策略配置。

###### 数据设计
```
使用Express中间件模式实现权限检查，接收所需权限作为参数，验证当前用户是否拥有该权限，并决定是允许请求继续还是返回权限错误。
```

###### 算法和流程
- **权限验证流程**：
  - 从请求中提取用户信息
  - 获取用户角色
  - 解析角色对应的权限集合
  - 检查是否包含所需权限
  - 通过或拒绝访问

###### 函数说明
- **authenticateToken(req, res, next)**：验证JWT令牌的中间件
- **checkPermission(permission)**：检查特定权限的中间件
- **checkRole(role)**：检查用户是否具有特定角色的中间件

##### 3.3.9.4、跨系统用户关联子模块

###### 设计图
```
跨系统用户关联子模块
    ├── 用户关联管理
    │   ├── 教师-学生关联
    │   ├── 关联查询
    │   └── 关联删除
    └── 身份转换
        ├── 教师视角切换
        ├── 学生视角切换
        └── 权限继承规则
```

###### 功能描述
跨系统用户关联子模块处理教师端和学生端用户在社区系统中的关联关系，使用户可以在不同系统间无缝切换身份，同时保持适当的权限隔离。该模块是实现教师和学生在社区中互动的基础。

###### 数据设计
```
通过扩展用户角色映射表，增加关联类型和状态字段，支持主次账号关联和关联状态管理，实现用户跨系统身份管理。
```

###### 算法和流程
- **用户关联流程**：
  - 验证两个用户身份
  - 检查关联请求有效性
  - 创建用户关联记录
  - 处理权限继承
  - 返回关联结果

###### 函数说明
- **associateUsers(teacherId, studentId)**：关联教师和学生账号
- **getUsersByAssociation(userId, userType)**：获取与指定用户关联的所有用户
- **switchUserContext(userId, targetType)**：切换用户上下文（如从教师切换到学生视角）

### 3.4、帖子和评论模块

#### 3.4.1、设计图
```
帖子和评论模块
    ├── 帖子路由(postRoutes.js)
    │   ├── GET /posts - 获取帖子列表
    │   ├── POST /posts - 创建帖子
    │   ├── GET /posts/:id - 获取帖子详情
    │   ├── PUT /posts/:id - 更新帖子
    │   └── DELETE /posts/:id - 删除帖子
    └── 评论路由(commentRoutes.js)
        ├── GET /comments/post/:postId - 获取帖子评论
        ├── POST /comments - 创建评论
        ├── PUT /comments/:id - 更新评论
        └── DELETE /comments/:id - 删除评论
```

#### 3.4.2、功能描述
帖子和评论模块是社区交流的核心，允许用户创建、查看和回复内容。支持内容分类、筛选和分页等功能，并实现评论树形结构，支持多级回复。

#### 3.4.3、输入数据
- 帖子内容：标题、正文、分类等
- 评论内容：文本、回复对象等
- 筛选条件：分类、时间、作者等
- 分页参数：页码、每页记录数

#### 3.4.4、输出数据
- 帖子列表：摘要信息的帖子集合
- 帖子详情：包含评论的完整帖子
- 评论列表：可能包含嵌套回复的评论树
- 操作结果：成功/失败状态和消息

#### 3.4.5、数据设计
使用posts和comments表存储内容（见2.3节）

#### 3.4.6、算法和流程
1. **帖子列表获取流程**:
   - 应用筛选条件
   - 计算分页参数
   - 查询帖子列表
   - 关联作者信息
   - 计算评论数量
   - 返回分页结果

2. **评论创建流程**:
   - 验证帖子存在性
   - 检查权限
   - 内容过滤
   - 保存评论
   - 更新计数器
   - 返回新评论

#### 3.4.7、函数说明
- **getPosts(req, res)**
  - 功能：获取帖子列表
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON帖子列表)

- **createPost(req, res)**
  - 功能：创建新帖子
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON新帖子)

#### 3.4.8、全局数据结构与该模块的关系
该模块操作posts和comments表，与互动模块交互，构成社区核心功能。

#### 3.4.9、子模块设计

##### 3.4.9.1、内容发布与管理子模块

###### 设计图
```
内容发布与管理子模块
    ├── 帖子管理
    │   ├── 创建帖子
    │   ├── 编辑帖子
    │   ├── 删除帖子
    │   └── 帖子状态管理
    └── 内容元数据
        ├── 分类管理
        ├── 标签管理
        └── SEO优化
```

###### 功能描述
内容发布与管理子模块提供帖子的全生命周期管理功能，包括创建、编辑、删除和状态管理。同时支持内容分类、标签系统和SEO优化，提升内容的可发现性和组织性。

###### 数据设计
```
系统包含内容分类表、标签表和帖子-标签关联表，支持多层分类结构和标签管理，实现内容的分类组织和标签索引功能。
```

###### 算法和流程
- **帖子发布流程**：
  - 验证用户权限
  - 内容和元数据验证
  - 处理分类和标签
  - 保存帖子内容
  - 更新索引和计数
  - 返回发布结果

###### 函数说明
- **createPost(postData, authorId, authorType)**：创建新帖子
- **updatePostStatus(postId, status)**：更新帖子状态
- **attachCategories(postId, categoryIds)**：为帖子分配分类
- **manageTags(postId, tags)**：管理帖子标签

##### 3.4.9.2、评论树管理子模块

###### 设计图
```
评论树管理子模块
    ├── 评论操作
    │   ├── 创建评论
    │   ├── 回复评论
    │   └── 管理评论
    └── 树形结构
        ├── 层级控制
        ├── 树形查询
        └── 评论排序
```

###### 功能描述
评论树管理子模块负责处理评论的层级结构，支持多级嵌套回复，同时提供评论的创建、回复和管理功能，并实现评论的排序和分页加载，优化用户体验。

###### 数据设计
```
使用递归算法构建评论树形结构，将线性评论列表转换为嵌套的树形结构，支持多级评论展示和操作。
```

###### 算法和流程
- **评论树构建流程**：
  - 获取评论列表
  - 构建ID-评论映射
  - 建立父子关系
  - 提取根评论
  - 递归构建树结构
  - 返回评论树

###### 函数说明
- **createComment(postId, content, authorId, authorType, parentId)**：创建评论或回复
- **getCommentsByPostId(postId, page, limit)**：获取帖子评论
- **buildCommentTree(comments)**：构建评论树
- **getCommentDepth(commentId)**：获取评论在树中的深度

##### 3.4.9.3、内容过滤与审核子模块

###### 设计图
```
内容过滤与审核子模块
    ├── 内容过滤
    │   ├── 敏感词过滤
    │   ├── 垃圾内容检测
    │   └── 格式净化
    └── 内容审核
        ├── 举报处理
        ├── 审核工作流
        └── 自动审核
```

###### 功能描述
内容过滤与审核子模块负责保障社区内容质量和合规性，通过自动和人工方式过滤敏感内容、垃圾信息，并提供内容举报和审核功能，确保社区环境健康。

###### 数据设计
```
包含敏感词表和内容举报表，支持对敏感内容的自动过滤和用户举报的处理流程，提供多级别的内容风险控制机制。
```

###### 算法和流程
- **内容过滤流程**：
  - 接收原始内容
  - 应用敏感词过滤
  - 检测垃圾内容特征
  - 格式化和净化处理
  - 返回处理后内容或拒绝发布

###### 函数说明
- **filterContent(content, options)**：过滤内容中的敏感信息
- **reportContent(contentType, contentId, reporterId, reporterType, reason)**：举报内容
- **reviewReport(reportId, action, reviewerId)**：处理内容举报

##### 3.4.9.4、互动统计子模块

###### 设计图
```
互动统计子模块
    ├── 基础互动
    │   ├── 点赞管理
    │   ├── 浏览统计
    │   └── 收藏管理
    └── 数据分析
        ├── 热度计算
        ├── 活跃度统计
        └── 推荐算法
```

###### 功能描述
互动统计子模块管理用户与内容的互动行为，包括点赞、浏览、收藏等，同时提供数据统计和分析功能，计算内容热度，支持内容推荐和排序。该模块为提升用户参与度和内容质量提供数据支持。

###### 数据设计
```
使用用户内容互动表存储用户与内容间的交互记录，包括用户ID、用户类型、内容类型、内容ID、互动类型和时间等信息，为热度计算和推荐算法提供数据基础。
```

###### 算法和流程
- **热度计算流程**：
  - 获取内容互动数据
  - 按类型加权计算
  - 考虑时间衰减因子
  - 计算最终热度分数
  - 更新内容热度值

###### 函数说明
- **recordInteraction(userId, userType, contentType, contentId, interactionType)**：记录用户互动
- **getContentStatistics(contentType, contentId)**：获取内容统计数据
- **calculateHotScore(contentType, contentId)**：计算内容热度分数
- **getRecommendedContent(userId, userType, limit)**：获取推荐内容

## 4、接口设计

### 4.1、用户接口
服务器不直接提供用户界面，而是通过RESTful API与前端交互。

### 4.2、外部接口
系统提供RESTful API，使用HTTP/HTTPS协议与前端通信，API前缀为'/api/community'：

1. **角色管理接口**
   - `GET /api/community/roles/user/:userId`: 获取用户角色
   - `POST /api/community/roles/assign`: 分配角色
   - `DELETE /api/community/roles/revoke`: 撤销角色

2. **帖子管理接口**
   - `GET /api/community/posts`: 获取帖子列表
   - `POST /api/community/posts`: 创建帖子
   - `GET /api/community/posts/:id`: 获取帖子详情
   - `PUT /api/community/posts/:id`: 更新帖子
   - `DELETE /api/community/posts/:id`: 删除帖子

3. **评论管理接口**
   - `GET /api/community/comments/post/:postId`: 获取帖子评论
   - `POST /api/community/comments`: 创建评论
   - `PUT /api/community/comments/:id`: 更新评论
   - `DELETE /api/community/comments/:id`: 删除评论

### 4.3、内部接口

#### 4.3.1、接口说明
模块间通过函数调用进行交互，主要涉及：
- 用户角色映射模块提供权限验证功能
- 内容过滤系统处理用户输入

#### 4.3.2、调用方式
```
通过Express路由中间件链实现权限验证，使用authenticateToken验证用户身份，checkPermission验证特定权限，将验证通过的请求传递给路由处理函数。
```

## 5、数据库设计 
系统使用MySQL关系型数据库，表结构详见2.3节。主要数据表关系如下：

- user_role_mapping表：存储用户角色关系，连接学生和教师账号
- posts表：存储社区帖子内容
- comments表：存储评论内容，自引用关系支持回复树

## 6、系统出错处理 

### 6.1、出错信息
| 错误类型   | 错误代码 | 错误信息               | 处理方式                    |
| ---------- | -------- | ---------------------- | --------------------------- |
| 认证错误   | 401      | "未授权：请登录"       | 返回401状态码和错误信息     |
| 权限错误   | 403      | "禁止：权限不足"       | 返回403状态码和错误信息     |
| 资源不存在 | 404      | "未找到：[资源]不存在" | 返回404状态码和错误信息     |
| 请求无效   | 400      | "请求无效：[具体原因]" | 返回400状态码和详细错误     |
| 服务器错误 | 500      | "服务器内部错误"       | 记录错误日志，返回500状态码 |

### 6.2、补救措施
- **全局错误处理**：使用中间件捕获未处理异常
- **输入验证**：验证所有请求数据，及早捕获错误
- **事务管理**：使用数据库事务确保多步操作一致性
- **错误日志**：详细记录错误信息，包括栈跟踪

## 7、其他设计

### 7.1、安全设计
- **权限控制**：实现基于角色的严格权限控制
- **输入验证**：过滤所有用户输入，防止XSS攻击
- **参数化查询**：使用绑定参数防止SQL注入
- **内容审核**：提供内容举报机制和自动敏感词检测

### 7.2、性能设计
- **数据库优化**：使用适当索引，优化查询
- **缓存策略**：缓存热门内容和用户配置
- **分页处理**：大数据集分页返回，减少响应大小
- **异步处理**：使用异步机制处理耗时操作 