# 教师端后端系统详细设计

## 1、系统概述

### 1.1、系统简介
教师端后端系统是一个基于Node.js和Express框架开发的Web服务器，为教师提供安全的API接口，支持教师用户管理、班级管理、试卷管理、题目管理等功能，并与学生端系统进行交互，实现教学管理的完整闭环。

### 1.2、术语表  
| 序号 | 术语或缩略语 | 说明性定义 |
| ---- | ------------ | ---------- |
| 1    | Express      | 基于Node.js的Web应用框架，提供HTTP服务器功能 |
| 2    | JWT          | JSON Web Token，用于用户身份验证的开放标准 |
| 3    | REST API     | 遵循REST架构风格的应用程序接口 |
| 4    | MySQL        | 关系型数据库管理系统 |
| 5    | Middleware   | 中间件，Express框架中处理HTTP请求的函数 |
| 6    | Swagger      | API文档生成工具 |

### 1.3、系统运行环境 
- **硬件平台**：标准服务器或云服务器
- **操作系统**：Linux、Windows或macOS
- **运行环境**：Node.js 18.x或更高版本
- **数据库系统**：MySQL 8.x
- **网络协议**：HTTP/HTTPS
- **端口**：3002

### 1.4、开发环境 
- **开发语言**：JavaScript (Node.js)
- **Web框架**：Express 4.x
- **数据库驱动**：mysql2 3.x
- **认证库**：jsonwebtoken 9.x, bcrypt 5.x
- **API文档**：swagger-jsdoc 6.x, swagger-ui-express 5.x
- **版本控制**：Git
- **代码编辑器**：VS Code或其他现代IDE

## 2、数据结构说明

### 2.1、常量
- **配置常量**
  - `JWT_SECRET`：JWT签名密钥，用于生成和验证令牌
  - `PORT`：服务器端口，默认为3002
  - `CORS_ORIGIN`：允许的跨域来源

- **路由常量**
  - `API_PREFIX`：API路径前缀，通常为空或'/api'
  - `ROUTES`：路由路径常量

- **数据库常量**
  - `DB_CONFIG`：数据库连接配置

### 2.2、变量
- **全局变量**
  - `app`：Express应用实例
  - `pool`：MySQL连接池
  - `routes`：路由模块集合

### 2.3、数据结构

#### 数据库表结构
1. **教师表 (teachers)**
教师表存储教师基本信息，包含id、姓名、性别、教师ID(唯一)、联系方式(电话、邮箱、微信)、学校、加密密码、注册时间和最后登录时间等字段。

2. **班级表 (classes)**
班级表存储班级信息，包含id、班级名称、描述、班级唯一码、创建时间和教师ID外键，教师ID字段与教师表进行关联。

3. **班级学生表 (class_students)**
班级学生表维护班级与学生的多对多关系，包含id、班级id、学生id和加入时间字段，班级id与classes表关联，并对班级id和学生id建立唯一索引。

4. **试卷表 (exams)**
试卷表存储试卷信息，包含id、标题、描述、科目、年级、总分、创建时间、更新时间和教师id外键，教师id与教师表进行关联。

5. **题目表 (questions)**
题目表存储试卷题目信息，包含id、试卷id、题型(单选、多选、判断、填空、问答)、内容、选项(JSON格式)、正确答案、分值和题目顺序，试卷id与exams表关联。

6. **LaTeX题目表 (latex_questions)**
LaTeX题目表存储数学等专业试题，包含id、题目路径、科目、年级、年份、类型、文件夹名称、正确答案、备注、LaTeX代码、创建和更新时间字段。

#### API请求/响应数据结构
1. **教师认证**
教师登录请求包含教师ID和密码字段；登录响应包含JWT令牌和教师基本信息(ID、姓名、教师ID、学校、邮箱、电话)。

2. **班级管理**
班级创建请求包含名称和可选的描述字段；班级响应包含ID、名称、描述、班级码、创建时间、教师ID及可选的学生数量。

3. **试卷管理**
试卷创建请求包含标题、可选描述、科目、年级、总分和可选的题目数组；题目创建请求包含题型(单选、多选、判断、填空或问答)、内容、可选选项、正确答案、分值和可选的题目顺序。

## 3、模块设计  

### 3.1、软件结构  

#### 系统架构图
```
backend/safe-teachsever/
├── server.js                  # 服务器入口
├── swagger.js                 # Swagger文档配置
├── routes/                    # 路由模块
│   ├── authRoutes.js          # 认证路由
│   ├── classRoutes.js         # 班级管理路由
│   ├── examRoutes.js          # 试卷管理路由
│   ├── exportRoutes.js        # 数据导出路由
│   └── latexQuestionRoutes.js # LaTeX题目路由
├── controllers/               # 控制器模块
│   ├── authController.js      # 认证控制器
│   ├── classController.js     # 班级控制器
│   └── examController.js      # 试卷控制器
├── models/                    # 数据模型
│   ├── teacherModel.js        # 教师模型
│   ├── classModel.js          # 班级模型
│   └── examModel.js           # 试卷模型
└── test-function/             # 测试功能模块
```

### 3.2、功能设计说明 
系统采用MVC架构模式，通过路由(Routes)接收请求，控制器(Controllers)处理业务逻辑，模型(Models)操作数据库。使用中间件处理认证、授权和错误，通过Swagger提供API文档。API设计遵循RESTful风格，使用JWT进行身份验证。系统与学生端和社区服务共享部分数据，实现完整的教学管理闭环。

### 3.3、认证模块

#### 3.3.1、设计图
```
认证模块
    ├── 路由层(authRoutes.js)
    │   ├── POST /register - 教师注册
    │   └── POST /login - 教师登录
    ├── 控制器层(authController.js)
    │   ├── register() - 处理注册
    │   └── login() - 处理登录
    └── 模型层(teacherModel.js)
        ├── createTeacher() - 创建教师记录
        ├── findTeacherById() - 根据ID查找教师
        └── findTeacherByTeacherId() - 根据教师ID查找教师
```

#### 3.3.2、功能描述
认证模块负责教师用户的注册、登录和身份验证，确保只有合法用户能访问系统功能。用户密码使用bcrypt加密存储，认证成功后发放JWT令牌。

#### 3.3.3、输入数据
- 注册信息：教师ID、姓名、学校、密码等
- 登录凭据：教师ID、密码
- 身份验证：HTTP请求头中的Bearer令牌

#### 3.3.4、输出数据
- 注册结果：成功/失败状态和消息
- 登录结果：JWT令牌、教师基本信息
- 身份验证结果：成功或未授权错误

#### 3.3.5、数据设计
使用teachers表存储教师信息（见2.3节）以及以下请求响应结构：

```typescript
// 注册请求
interface RegisterRequest {
  teacher_id: string;  // 教师工号
  name: string;        // 教师姓名
  school: string;      // 所属学校
  password: string;    // 密码
  gender?: string;     // 性别
  email?: string;      // 邮箱
  phone?: string;      // 电话
  wechat?: string;     // 微信号
}

// 注册响应
interface RegisterResponse {
  success: boolean;
  message: string;
  teacher?: {
    id: number;
    teacher_id: string;
    name: string;
  };
}
```

#### 3.3.6、算法和流程
1. **注册流程**:
   - 验证请求数据完整性和格式
   - 检查教师ID是否已存在
   - 密码加密处理
   - 创建教师记录
   - 返回结果

2. **登录流程**:
   - 验证请求数据完整性
   - 查询教师记录
   - 验证密码
   - 生成JWT令牌
   - 更新最后登录时间
   - 返回令牌和基本信息

3. **身份验证流程**:
   - 从请求头提取Bearer令牌
   - 验证令牌有效性
   - 解析令牌载荷获取教师ID
   - 查询教师信息
   - 将教师信息附加到请求对象

#### 3.3.7、函数说明
- **register(req, res)**
  - 功能：处理教师注册
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON)

- **login(req, res)**
  - 功能：处理教师登录
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON)

- **authenticateTeacher(req, res, next)**
  - 功能：教师身份验证中间件
  - 参数：req(请求对象), res(响应对象), next(下一个中间件)
  - 返回：调用next()或返回错误响应

#### 3.3.8、全局数据结构与该模块的关系
该模块使用teachers表存储教师信息，生成的JWT令牌在整个系统中用于身份验证。

#### 3.3.9、子模块设计

##### 3.3.9.1、用户注册子模块

###### 设计图
```
用户注册子模块
    ├── 参数验证
    │   ├── 必填项检查
    │   ├── 格式验证
    │   └── 业务规则验证
    └── 账号创建
        ├── 密码加密
        ├── 数据持久化
        └── 结果响应
```

###### 功能描述
用户注册子模块负责处理教师账号的创建过程，确保注册信息完整且符合系统规则，对密码进行安全加密，并将用户信息持久化到数据库。该模块实现教师身份的初始化，为后续身份验证和授权提供基础。

###### 数据设计
模块使用教师数据模型定义注册信息的结构和验证规则，包括必填项检查、格式验证和教师工号唯一性检查，确保创建的账号信息准确可靠。

###### 算法和流程
注册处理流程包括参数验证、教师工号查重、密码加密、记录创建和结果返回，通过多层次的验证和处理，确保注册流程的安全和数据完整性。

###### 函数说明
主要功能包括请求验证、教师记录查询、密码哈希生成和教师记录创建，所有功能通过统一的控制器函数提供，确保注册过程高效安全。

##### 3.3.9.2、用户登录子模块

###### 设计图
```
用户登录子模块
    ├── 凭证验证
    │   ├── 用户查询
    │   ├── 密码比对
    │   └── 登录状态更新
    └── 令牌管理
        ├── JWT生成
        ├── 载荷构建
        └── 令牌签名
```

###### 功能描述
用户登录子模块负责教师账号的身份验证，验证提供的凭证是否匹配，成功后生成包含身份信息的JWT令牌，并更新用户的登录状态。该模块是用户访问系统的安全门户，确保只有合法用户能获取访问令牌。

###### 数据设计
模块使用教师信息和认证状态数据，通过bcrypt进行密码验证，使用JWT规范定义令牌结构，包括过期时间、签名密钥和用户标识，支持安全的身份验证流程。

###### 算法和流程
登录流程包括用户查询、密码验证、令牌生成和登录状态更新，使用加密算法确保密码验证安全，生成的JWT令牌包含必要的身份信息，便于后续授权验证。

###### 函数说明
主要功能包括用户凭证验证、密码比对、JWT生成和用户状态更新，通过统一的接口提供给认证路由，实现完整的登录认证过程。

##### 3.3.9.3、身份验证中间件子模块

###### 设计图
```
身份验证中间件子模块
    ├── 令牌提取
    │   ├── 请求头解析
    │   ├── 令牌格式验证
    │   └── 载荷提取
    └── 身份确认
        ├── 令牌验证
        ├── 用户查询
        └── 请求注入
```

###### 功能描述
身份验证中间件子模块为系统提供请求级别的认证功能，从请求中提取和验证JWT令牌，确认用户身份，并将用户信息注入到请求对象中。该模块是系统安全的关键组件，保护受限资源只对授权用户开放。

###### 数据设计
模块处理HTTP请求和JWT令牌数据，定义令牌验证逻辑和错误处理策略，支持从不同请求来源（如头部、查询参数、Cookie）提取令牌，确保认证机制的灵活性。

###### 算法和流程
认证流程包括令牌提取、JWT验证、用户查询和请求增强，对无效令牌或未授权请求返回标准化的错误响应，确保系统API的安全访问。

###### 函数说明
主要功能包括Bearer令牌提取、JWT验证、用户身份查询和请求上下文增强，作为Express中间件使用，可应用于整个应用或特定路由组。

### 3.4、班级管理模块

#### 3.4.1、设计图
```
班级管理模块
    ├── 路由层(classRoutes.js)
    │   ├── GET / - 获取班级列表
    │   ├── POST / - 创建班级
    │   ├── GET /:id - 获取班级详情
    │   ├── PUT /:id - 更新班级信息
    │   ├── DELETE /:id - 删除班级
    │   ├── GET /:id/students - 获取班级学生
    │   ├── POST /:id/students - 添加学生到班级
    │   └── DELETE /:id/students/:studentId - 从班级移除学生
    ├── 控制器层(classController.js)
    │   ├── getClasses() - 获取班级列表
    │   ├── createClass() - 创建班级
    │   ├── getClassById() - 获取班级详情
    │   ├── updateClass() - 更新班级
    │   ├── deleteClass() - 删除班级
    │   ├── getClassStudents() - 获取班级学生
    │   ├── addStudentToClass() - 添加学生
    │   └── removeStudentFromClass() - 移除学生
    └── 模型层(classModel.js)
        ├── findClassesByTeacherId() - 查询教师班级
        ├── createClass() - 创建班级
        ├── findClassById() - 查询班级详情
        ├── updateClass() - 更新班级
        ├── deleteClass() - 删除班级
        ├── findClassStudents() - 查询班级学生
        ├── addStudent() - 添加学生
        └── removeStudent() - 移除学生
```

#### 3.4.2、功能描述
班级管理模块允许教师创建和管理班级，添加和移除学生，查看班级和学生列表。每个班级生成唯一邀请码，供学生加入。

#### 3.4.3、输入数据
- 班级信息：名称、描述等
- 学生ID：要添加或移除的学生
- 教师ID：当前认证教师ID (从JWT)

#### 3.4.4、输出数据
- 班级列表和详情
- 班级学生列表
- 操作结果状态和消息

#### 3.4.5、数据设计
使用classes和class_students表（见2.3节）

#### 3.4.6、算法和流程
1. **创建班级流程**:
   - 验证请求数据
   - 生成唯一班级码
   - 创建班级记录
   - 返回新班级信息

2. **管理班级学生流程**:
   - 验证班级存在性和教师权限
   - 执行学生添加或移除操作
   - 返回操作结果

#### 3.4.7、函数说明
- **getClasses(req, res)**
  - 功能：获取教师的班级列表
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON班级列表)

- **createClass(req, res)**
  - 功能：创建新班级
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON新班级信息)

- **getClassStudents(req, res)**
  - 功能：获取班级学生列表
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON学生列表)

#### 3.4.8、全局数据结构与该模块的关系
该模块操作classes和class_students表，与教师和学生模块关联。

#### 3.4.9、子模块设计

##### 3.4.9.1、班级基础管理子模块

###### 设计图
```
班级基础管理子模块
    ├── 班级创建与编辑
    │   ├── 信息验证
    │   ├── 班级码生成
    │   └── 数据持久化
    └── 班级查询与删除
        ├── 教师权限验证
        ├── 班级信息查询
        └── 班级数据清理
```

###### 功能描述
班级基础管理子模块提供班级的核心管理功能，包括创建、查询、更新和删除班级。该模块生成唯一的班级邀请码，确保班级信息的准确性和完整性，并维护教师与班级之间的关联关系。

###### 数据设计
模块使用班级数据模型定义班级信息结构，包括名称、描述、班级码和教师关联，支持班级信息的增删改查，并实现基于教师ID的班级权限控制。

###### 算法和流程
班级管理流程包括数据验证、唯一班级码生成、记录创建与更新、权限检查和条件查询，确保每个教师只能管理其创建的班级，并提供高效的班级信息检索。

###### 函数说明
主要功能包括班级信息验证、班级记录创建与更新、班级查询和班级删除，所有功能通过统一的控制器函数提供，支持完整的班级生命周期管理。

##### 3.4.9.2、学生管理子模块

###### 设计图
```
学生管理子模块
    ├── 班级学生管理
    │   ├── 学生添加
    │   ├── 学生查询
    │   └── 学生移除
    └── 学生数据处理
        ├── 批量导入
        ├── 数据排序
        └── 结果分页
```

###### 功能描述
学生管理子模块负责管理班级中的学生，支持添加、查询和移除学生，以及批量导入学生数据。该模块维护班级与学生之间的关联关系，确保教师能有效管理班级学生，并控制学生对班级资源的访问。

###### 数据设计
模块使用班级学生关联表存储班级与学生的多对多关系，支持基于班级ID的学生查询和基于学生ID的班级查询，实现灵活的学生管理和权限控制。

###### 算法和流程
学生管理流程包括学生存在性验证、班级权限检查、关联记录操作和结果处理，支持单个或批量学生的添加和移除，并提供分页和排序功能，优化大量学生数据的处理。

###### 函数说明
主要功能包括学生添加、学生查询、学生移除和批量数据处理，所有功能通过统一的API提供，确保班级学生管理的安全性和高效性。

##### 3.4.9.3、班级数据分析子模块

###### 设计图
```
班级数据分析子模块
    ├── 统计分析
    │   ├── 学生统计
    │   ├── 成绩分析
    │   └── 活动记录
    └── 数据导出
        ├── 班级报告
        ├── 成绩单生成
        └── 格式转换
```

###### 功能描述
班级数据分析子模块提供班级相关数据的统计、分析和导出功能，帮助教师了解班级学生的整体情况和学习进度。该模块处理班级学生的成绩数据，生成统计报告，并支持多种格式的数据导出，便于教师进行教学评估和调整。

###### 数据设计
模块整合班级信息、学生数据和成绩记录，构建统计分析模型，支持多维度的数据查询和聚合，为班级报告和成绩单生成提供数据基础。

###### 算法和流程
数据分析流程包括原始数据收集、数据清理、统计计算、图表生成和格式转换，支持不同粒度的数据分析，从单个学生到整个班级，提供全面的教学质量评估工具。

###### 函数说明
主要功能包括学生数据统计、成绩分析、活动记录汇总和报告生成，所有功能通过统一的接口提供，支持教师对班级教学效果的科学评估和管理。

### 3.5、试卷与题目管理模块

#### 3.5.1、设计图
```
试卷与题目管理模块
    ├── 路由层
    │   ├── examRoutes.js
    │   │   ├── GET / - 获取试卷列表
    │   │   ├── POST / - 创建试卷
    │   │   ├── GET /:id - 获取试卷详情
    │   │   ├── PUT /:id - 更新试卷
    │   │   ├── DELETE /:id - 删除试卷
    │   │   ├── POST /:id/questions - 添加题目
    │   │   └── DELETE /:id/questions/:questionId - 删除题目
    │   └── latexQuestionRoutes.js
    │       ├── GET / - 获取LaTeX题目列表
    │       ├── POST / - 创建LaTeX题目
    │       └── GET /:id - 获取LaTeX题目详情
    ├── 控制器层
    │   ├── examController.js
    │   │   ├── getExams() - 获取试卷列表
    │   │   ├── createExam() - 创建试卷
    │   │   ├── getExamById() - 获取试卷详情
    │   │   ├── updateExam() - 更新试卷
    │   │   ├── deleteExam() - 删除试卷
    │   │   ├── addQuestion() - 添加题目
    │   │   └── deleteQuestion() - 删除题目
    │   └── latexQuestionController.js
    │       ├── getLatexQuestions() - 获取LaTeX题目
    │       ├── createLatexQuestion() - 创建LaTeX题目
    │       └── getLatexQuestionById() - 获取LaTeX题目详情
    └── 模型层
        ├── examModel.js - 试卷数据模型
        └── latexQuestionModel.js - LaTeX题目数据模型
```

#### 3.5.2、功能描述
试卷与题目管理模块允许教师创建和管理试卷，添加和编辑题目，包括普通题目和LaTeX格式题目。

#### 3.5.3、输入数据
- 试卷信息：标题、描述、科目、年级等
- 题目信息：类型、内容、选项、答案、分值等
- LaTeX题目信息：代码、路径、答案等

#### 3.5.4、输出数据
- 试卷列表和详情
- 题目列表和详情
- LaTeX题目详情
- 操作结果状态和消息

#### 3.5.5、数据设计
使用exams、questions和latex_questions表（见2.3节）

#### 3.5.6、算法和流程
1. **创建试卷流程**:
   - 验证请求数据
   - 创建试卷记录
   - 处理题目数据（如果包含）
   - 返回新试卷信息

2. **LaTeX题目管理流程**:
   - 验证LaTeX代码和元数据
   - 存储LaTeX内容和路径
   - 关联正确答案
   - 返回题目信息

#### 3.5.7、函数说明
- **createExam(req, res)**
  - 功能：创建新试卷
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON新试卷信息)

- **addQuestion(req, res)**
  - 功能：向试卷添加题目
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON新题目信息)

- **createLatexQuestion(req, res)**
  - 功能：创建LaTeX题目
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(JSON新LaTeX题目信息)

#### 3.5.8、全局数据结构与该模块的关系
该模块操作exams、questions和latex_questions表，与教师模块关联。

#### 3.5.9、子模块设计

##### 3.5.9.1、试卷管理子模块

###### 设计图
```
试卷管理子模块
    ├── 试卷基础管理
    │   ├── 试卷创建
    │   ├── 试卷编辑
    │   ├── 试卷查询
    │   └── 试卷删除
    └── 试卷元数据管理
        ├── 科目分类
        ├── 年级设置
        └── 标签管理
```

###### 功能描述
试卷管理子模块负责试卷的全生命周期管理，支持创建、查询、更新和删除试卷，以及试卷的分类和标签管理。该模块维护试卷的基本信息和元数据，提供结构化的试卷组织和检索功能，便于教师高效管理教学资源。

###### 数据设计
模块使用试卷数据模型定义试卷信息结构，包括标题、描述、科目、年级、总分和创建者关联，支持试卷的分类和标签系统，实现多维度的试卷组织和检索。

###### 算法和流程
试卷管理流程包括数据验证、记录创建与更新、权限检查和条件查询，支持基于多个条件的试卷检索，并确保教师只能管理自己创建的试卷，提供安全的试卷管理机制。

###### 函数说明
主要功能包括试卷信息验证、试卷记录操作、试卷查询和元数据管理，所有功能通过统一的控制器函数提供，支持完整的试卷管理功能。

##### 3.5.9.2、题目管理子模块

###### 设计图
```
题目管理子模块
    ├── 基础题目管理
    │   ├── 题目创建
    │   ├── 题目编辑
    │   ├── 题目查询
    │   └── 题目删除
    └── 题型处理
        ├── 选择题处理
        ├── 填空题处理
        └── 问答题处理
```

###### 功能描述
题目管理子模块提供题目的管理功能，支持多种题型的创建、编辑、查询和删除，以及与试卷的关联管理。该模块处理不同题型的特殊逻辑，包括选项管理、答案验证和分值计算，确保题目数据的准确性和完整性。

###### 数据设计
模块使用题目数据模型定义不同题型的信息结构，包括内容、选项、正确答案、分值和顺序，支持题目与试卷的关联关系，实现灵活的题目组织和管理。

###### 算法和流程
题目管理流程包括题型判断、数据验证、选项格式化、答案标准化和记录操作，针对不同题型提供专门的处理逻辑，确保所有题型的数据都能正确存储和检索。

###### 函数说明
主要功能包括题目信息验证、题目记录操作、题型转换和批量题目处理，所有功能通过统一的API提供，支持教师高效管理题目资源。

##### 3.5.9.3、LaTeX题目管理子模块

###### 设计图
```
LaTeX题目管理子模块
    ├── LaTeX处理
    │   ├── 代码解析
    │   ├── 渲染处理
    │   └── 路径管理
    └── 元数据管理
        ├── 分类索引
        ├── 答案关联
        └── 备注管理
```

###### 功能描述
LaTeX题目管理子模块负责数学和科学类LaTeX格式题目的处理和管理，支持LaTeX代码的解析、渲染和存储，以及相关元数据的管理。该模块提供专门的LaTeX题库功能，帮助教师创建和管理高质量的数学和科学题目，提升教学资源的专业性。

###### 数据设计
模块使用LaTeX题目数据模型定义LaTeX题目的结构，包括LaTeX代码、渲染路径、科目分类、年级、正确答案和备注信息，支持LaTeX题目的分类和检索，实现专业数学题库的构建。

###### 算法和流程
LaTeX题目管理流程包括LaTeX代码验证、渲染处理、文件路径管理和元数据索引，支持LaTeX代码的编辑和预览，确保渲染结果的准确性，并提供高效的题目检索机制。

###### 函数说明
主要功能包括LaTeX代码处理、渲染服务集成、文件管理和元数据索引，所有功能通过统一的接口提供，支持教师高效管理LaTeX格式的专业题目。

##### 3.5.9.4、试卷分发与收集子模块

###### 设计图
试卷分发与收集子模块分为两部分：试卷分发(包含班级分发、个人分发和时间设置)和答卷收集(包含提交验证、自动批改和状态跟踪)。

###### 功能描述
试卷分发与收集子模块负责管理试卷的发布、分发和答卷收集过程，支持向班级或个人分发试卷，设置答题时间限制，并收集和处理学生提交的答卷。该模块是教学测评流程的关键环节，确保试卷能高效地分发给目标学生，并及时收集和处理答卷。

###### 数据设计
模块定义试卷分发记录和答卷收集数据结构，包括分发对象、开始时间、结束时间、状态和提交记录，支持试卷分发状态的跟踪和管理，实现完整的试卷分发闭环。

###### 算法和流程
试卷分发流程包括目标确定、时间设置、权限分配和状态通知，答卷收集流程包括提交验证、时间检查、自动批改和状态更新，确保整个测评过程的有序进行和数据安全。

###### 函数说明
主要功能包括试卷分发记录创建、时间限制设置、提交验证和自动批改启动，所有功能通过统一的接口提供，支持教师高效管理测评流程。

### 3.6、数据导出模块

#### 3.6.1、设计图
数据导出模块分为四层：路由层提供各类数据导出API(班级、学生、试卷、成绩、统计数据)，控制器层处理导出请求，服务层负责数据格式化和文件生成(Excel、CSV等)，工具层负责数据清洗、转换、模板应用和文件压缩。

#### 3.6.2、功能描述
数据导出模块提供教学数据的导出功能，支持班级、学生、试卷、成绩和统计数据的导出，便于教师进行教学管理和数据分析。该模块允许教师根据需求选择不同的数据范围、格式和过滤条件，生成标准格式的导出文件，满足教学管理、数据分析和报告生成的需求。该模块支持多种导出格式，包括CSV、Excel、PDF等，提供灵活的数据筛选、排序、分组和格式化选项，确保数据的可用性和可读性。

#### 3.6.3、输入数据
- 导出选项：筛选条件、格式选择、字段选择、模板设置
- 教师ID：当前认证教师ID (从JWT)
- 数据范围：指定的班级、学生或试卷ID范围
- 时间范围：开始和结束日期
- 格式参数：页眉、页脚、样式设置
- 安全控制：数据脱敏和权限控制选项

#### 3.6.4、输出数据
- 格式化的数据文件：CSV、Excel、PDF等格式
- 导出状态和统计信息：成功记录数、处理时间等
- 下载链接或文件流：直接提供文件下载
- 导出日志：记录导出操作和参数
- 错误报告：数据处理过程中的异常和警告

#### 3.6.5、数据设计
模块不创建新的数据表，而是整合并处理现有的班级、学生、试卷和成绩数据。它使用以下导出配置和结果格式：

```typescript
// 导出配置
interface ExportConfig {
  format: 'csv' | 'excel' | 'pdf';
  fields?: string[];
  filter?: any;
  sort?: { field: string, order: 'asc' | 'desc' }[];
  groupBy?: string[];
  pagination?: { page: number, pageSize: number };
  includeHeader: boolean;
  templateId?: number;
  fileName?: string;
  security?: {
    anonymize?: boolean;
    maskFields?: string[];
    encryptFile?: boolean;
  };
}

// 导出结果
interface ExportResult {
  success: boolean;
  fileName: string;
  fileSize: number;
  format: string;
  recordCount: number;
  processTime: number;
  downloadUrl?: string;
  expiresAt?: number;
  errors?: { message: string, code: string, field?: string }[];
}
```

#### 3.6.6、算法和流程
1. **数据导出流程**:
   - 验证请求参数和权限
   - 解析导出配置和选项
   - 查询相关数据库表
   - 应用筛选、排序和分组条件
   - 验证数据量和系统限制
   - 格式化和转换数据
   - 应用安全控制和脱敏
   - 生成目标格式文件
   - 记录导出操作和结果
   - 提供下载或返回文件流

2. **数据格式化流程**:
   - 提取原始数据集
   - 解析字段映射和转换规则
   - 应用数据清洗和验证
   - 处理特殊字段格式和类型
   - 组织数据层次结构
   - 计算衍生字段和汇总值
   - 添加头部和元数据信息
   - 应用样式和格式模板
   - 转换为目标格式
   - 执行文件优化和压缩

#### 3.6.7、函数说明
- **exportClassData(req, res)**
  - 功能：导出班级数据
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(文件流或下载链接)
  - 处理逻辑：验证权限，获取班级数据，应用格式化，生成文件

- **exportStudentData(req, res)**
  - 功能：导出学生数据
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(文件流或下载链接)
  - 处理逻辑：验证权限，获取学生数据，处理关系数据，生成文件

- **exportExamData(req, res)**
  - 功能：导出试卷数据
  - 参数：req(请求对象), res(响应对象)
  - 返回：HTTP响应(文件流或下载链接)
  - 处理逻辑：验证权限，获取试卷和题目数据，结构化内容，生成文件

- **formatDataToExcel(data, options)**
  - 功能：将数据格式化为Excel格式
  - 参数：data(数据集), options(格式化选项)
  - 返回：Buffer或Stream
  - 处理逻辑：创建工作簿，填充数据，应用样式，生成文件

- **sanitizeExportData(data, securityOptions)**
  - 功能：清理和保护导出数据
  - 参数：data(数据集), securityOptions(安全选项)
  - 返回：清理后的数据集
  - 处理逻辑：移除敏感字段，掩盖个人信息，处理权限限制数据

#### 3.6.8、全局数据结构与该模块的关系
该模块不创建新的数据结构，而是读取和处理由其他模块创建的数据，包括教师、班级、学生、试卷和成绩数据。它需要访问多个表进行数据关联和整合，同时要遵循数据访问权限控制，确保教师只能导出自己有权限的数据。

#### 3.6.9、子模块设计

##### 3.6.9.1、数据收集与筛选子模块

###### 设计图
数据收集与筛选子模块分为三部分：数据源接入(各类数据源接入)、查询构建(条件解析、参数验证、SQL生成和执行计划优化)和数据处理(结果过滤、关系组装、数据转换和结果分页)。

###### 功能描述
数据收集与筛选子模块负责从系统中收集需要导出的数据，并根据用户的筛选条件进行过滤和整理。该模块提供灵活的查询机制，支持复杂的筛选条件，确保导出的数据符合教师的需求。它处理数据源连接、查询参数解析、SQL构建和结果处理，支持高效的数据检索和大数据集的优化处理。

###### 数据设计
模块定义数据查询和筛选规则，支持基于各种条件的数据筛选，包括时间范围、关键词、状态和关联关系：

```typescript
// 查询参数
interface QueryParams {
  filters: {
    field: string;
    operator: 'eq' | 'ne' | 'gt' | 'lt' | 'in' | 'like' | 'between';
    value: any;
  }[];
  sort: {
    field: string;
    order: 'asc' | 'desc';
  }[];
  pagination: {
    page: number;
    pageSize: number;
  };
  relations: string[];
  groupBy?: string[];
  having?: {
    field: string;
    operator: string;
    value: any;
  }[];
}

// 数据源定义
interface DataSource {
  name: string;
  type: 'mysql' | 'mongo' | 'api' | 'cache';
  table: string;
  primaryKey: string;
  fields: {
    name: string;
    type: string;
    alias?: string;
    transform?: string;
  }[];
  relations: {
    name: string;
    targetSource: string;
    type: 'oneToOne' | 'oneToMany' | 'manyToOne';
    localKey: string;
    foreignKey: string;
  }[];
}
```

###### 算法和流程
数据收集流程包括以下关键步骤：

1. **请求解析流程**：
   - 解析HTTP请求参数
   - 验证和清理参数
   - 转换为内部查询格式
   - 应用默认值和限制
   - 验证权限和范围

2. **查询构建流程**：
   - 确定目标数据源
   - 构建基础查询结构
   - 添加筛选条件
   - 处理关系和联接
   - 添加排序和分组
   - 应用分页参数
   - 优化查询性能

3. **数据处理流程**：
   - 执行数据库查询
   - 处理查询结果集
   - 转换数据类型和格式
   - 组装关联数据
   - 计算衍生字段
   - 应用后处理过滤
   - 格式化最终结果

###### 函数说明
主要功能函数包括：

- **parseQueryParams(req)**：解析请求参数并转换为查询格式
- **validateQueryParams(params, schema)**：验证查询参数的有效性
- **buildSqlQuery(params, dataSource)**：构建SQL查询语句
- **executeQuery(query, params)**：执行数据库查询
- **processQueryResults(results, options)**：处理查询结果
- **assembleRelations(data, relations)**：组装关联数据
- **applyDataTransformations(data, transforms)**：应用数据转换
- **paginateResults(data, pagination)**：分页处理结果集

##### 3.6.9.2、格式转换与文件生成子模块

###### 设计图
格式转换与文件生成子模块分为三部分：数据转换(字段映射、类型转换、值格式化和结构组织)、模板应用(模板选择、变量替换、布局应用和样式处理)和文件生成(CSV生成、Excel生成、PDF生成、文件保存和压缩打包)。

###### 功能描述
格式转换与文件生成子模块负责将收集到的数据转换为指定的导出格式，并生成相应的文件。该模块支持多种常用的数据交换和报表格式，包括CSV、Excel和PDF，满足不同的数据导出和报表需求。它处理数据映射、格式转换、样式应用和文件生成，确保生成的文件符合标准格式规范并易于使用。

###### 数据设计
模块定义格式转换规则和文件模板，包括字段映射、值格式化和布局模板：

```typescript
// 导出模板
interface ExportTemplate {
  id: number;
  name: string;
  description: string;
  format: 'csv' | 'excel' | 'pdf';
  created_by: number;
  is_public: boolean;
  settings: {
    headers?: {
      enabled: boolean;
      text?: string;
      style?: any;
    };
    footers?: {
      enabled: boolean;
      text?: string;
      style?: any;
    };
    pageSettings?: {
      orientation: 'portrait' | 'landscape';
      size: string;
      margins: any;
    };
  };
  fieldMappings: {
    source: string;
    target: string;
    transform?: string;
    format?: string;
    style?: any;
  }[];
  sections?: {
    title?: string;
    dataSource: string;
    fields: string[];
    layout: any;
  }[];
}

// 格式配置
interface FormatConfig {
  csv?: {
    delimiter: string;
    quoteChar: string;
    includeHeader: boolean;
    encoding: string;
  };
  excel?: {
    sheetName: string;
    useStyles: boolean;
    freezeHeader: boolean;
    columnWidths?: {[field: string]: number};
    protection?: {
      password?: string;
      lockStructure: boolean;
    };
  };
  pdf?: {
    template: string;
    fonts?: any;
    compression: boolean;
    metadata?: any;
  };
}
```

###### 算法和流程
格式转换流程包括以下关键步骤：

1. **数据准备流程**：
   - 获取原始数据集
   - 应用字段映射规则
   - 执行数据类型转换
   - 格式化日期和数值
   - 处理特殊字符和编码
   - 组织数据结构层次

2. **模板应用流程**：
   - 加载指定的导出模板
   - 解析模板结构和设置
   - 将数据映射到模板
   - 应用头部和页眉设置
   - 处理表格布局和样式
   - 替换动态变量和公式

3. **文件生成流程**：
   - 根据目标格式选择生成器
   - 创建文件结构和内容
   - 应用格式化和样式
   - 添加元数据和属性
   - 生成文件并计算校验和
   - 选择性压缩和打包
   - 保存到临时存储

###### 函数说明
主要功能函数包括：

- **applyFieldMappings(data, mappings)**：应用字段映射规则
- **formatDataValues(data, formatRules)**：格式化数据值
- **loadExportTemplate(templateId)**：加载导出模板
- **applyTemplate(data, template)**：将模板应用到数据
- **generateCsvFile(data, options)**：生成CSV文件
- **generateExcelFile(data, options)**：生成Excel文件
- **generatePdfFile(data, template, options)**：生成PDF文件
- **compressFiles(files, options)**：压缩多个文件
- **storeExportFile(file, metadata)**：存储导出文件

##### 3.6.9.3、安全控制与授权子模块

###### 设计图
安全控制与授权子模块分为三部分：权限检查(身份验证、数据所有权、导出权限和配额控制)、敏感数据处理(数据鉴别、数据脱敏、字段过滤和数据加密)和操作审计(导出记录、安全日志、异常监控和统计分析)。

###### 功能描述
安全控制与授权子模块负责确保数据导出过程的安全性，验证用户权限，限制导出范围，并处理敏感数据。该模块实施数据导出的安全策略，防止未授权的数据访问和敏感信息泄露，保障学生和教学数据的安全。它管理权限控制、数据脱敏、操作审计和异常监控，确保数据导出符合隐私和安全要求。

###### 数据设计
模块定义权限规则和数据脱敏策略，包括访问控制列表、敏感字段标识和处理规则：

```typescript
// 导出权限
interface ExportPermission {
  role: string;
  resources: {
    type: 'class' | 'student' | 'exam' | 'result' | 'statistic';
    allowed: boolean;
    constraints?: {
      field: string;
      operator: 'eq' | 'in';
      value: any;
    }[];
    maxRecords?: number;
    formats?: string[];
    fields?: {
      name: string;
      access: 'allow' | 'deny' | 'mask';
    }[];
  }[];
}

// 数据脱敏规则
interface DataMaskingRule {
  field: string;
  type: 'student_id' | 'name' | 'contact' | 'score' | 'custom';
  strategy: 'full_mask' | 'partial_mask' | 'hash' | 'substitute' | 'remove';
  pattern?: string;
  replacement?: string;
  condition?: {
    field?: string;
    operator: string;
    value: any;
  };
}

// 导出审计记录
interface ExportAuditLog {
  id: number;
  userId: number;
  userName: string;
  userRole: string;
  timestamp: string;
  resourceType: string;
  resourceIds?: number[];
  format: string;
  recordCount: number;
  filters?: any;
  ipAddress: string;
  userAgent: string;
  status: 'success' | 'failed' | 'denied';
  errorMessage?: string;
}
```

###### 算法和流程
安全控制流程包括以下关键步骤：

1. **权限验证流程**：
   - 验证用户身份和令牌
   - 检查导出权限和角色
   - 验证资源访问权限
   - 应用资源约束条件
   - 检查导出配额和限制
   - 生成权限验证结果

2. **数据保护流程**：
   - 识别敏感数据字段
   - 应用字段访问控制
   - 执行数据脱敏转换
   - 过滤受限字段和记录
   - 验证结果数据安全性
   - 应用数据加密保护

3. **审计跟踪流程**：
   - 记录导出请求和参数
   - 捕获用户和环境信息
   - 记录处理时间和结果
   - 监控异常和安全事件
   - 生成安全审计日志
   - 分析导出模式和趋势

###### 函数说明
主要功能函数包括：

- **checkExportPermission(userId, resource, action)**：检查导出权限
- **verifyDataOwnership(userId, resourceType, resourceIds)**：验证数据所有权
- **applyResourceConstraints(query, constraints)**：应用资源约束
- **identifySensitiveFields(resource, schema)**：识别敏感字段
- **applyDataMasking(data, rules)**：应用数据脱敏
- **filterRestrictedFields(data, permissions)**：过滤受限字段
- **logExportActivity(userId, action, details)**：记录导出活动
- **monitorSecurityEvents(logs, patterns)**：监控安全事件
- **generateSecurityReport(timeRange, filters)**：生成安全报告

## 4、接口设计

### 4.1、用户接口
服务器不直接提供用户界面，而是通过RESTful API与前端交互。

### 4.2、外部接口
系统提供RESTful API，使用HTTP/HTTPS协议与前端通信：

1. **认证接口**
   - `POST /register`: 教师注册
   - `POST /login`: 教师登录

2. **班级接口**
   - `GET /classes`: 获取班级列表
   - `POST /classes`: 创建班级
   - `GET /classes/:id`: 获取班级详情
   - `PUT /classes/:id`: 更新班级信息
   - `DELETE /classes/:id`: 删除班级
   - `GET /classes/:id/students`: 获取班级学生
   - `POST /classes/:id/students`: 添加学生到班级

3. **试卷接口**
   - `GET /exams`: 获取试卷列表
   - `POST /exams`: 创建试卷
   - `GET /exams/:id`: 获取试卷详情
   - `PUT /exams/:id`: 更新试卷
   - `DELETE /exams/:id`: 删除试卷
   - `POST /exams/:id/questions`: 添加题目

4. **LaTeX题目接口**
   - `GET /api/latex-questions`: 获取LaTeX题目列表
   - `POST /api/latex-questions`: 创建LaTeX题目
   - `GET /api/latex-questions/:id`: 获取LaTeX题目详情

5. **数据导出接口**
   - `GET /api/export/classes`: 导出班级数据
   - `GET /api/export/students`: 导出学生数据
   - `GET /api/export/exams`: 导出试卷数据

### 4.3、内部接口

#### 4.3.1、接口说明
模块间通过函数调用进行交互，主要包括：
- 控制器调用模型函数进行数据操作
- 中间件验证请求有效性并传递给路由处理函数
- 路由处理函数调用控制器函数处理业务逻辑

#### 4.3.2、调用方式
```javascript
// 路由调用控制器示例
const express = require('express');
const classController = require('../controllers/classController');
const { authenticateTeacher } = require('../middleware/authMiddleware');

const router = express.Router();

// 应用认证中间件
router.use(authenticateTeacher);

// 路由定义，调用相应控制器函数
router.get('/', classController.getClasses);
router.post('/', classController.createClass);
router.get('/:id', classController.getClassById);

module.exports = router;
```

## 5、数据库设计 
系统使用MySQL关系型数据库，表结构详见2.3节。主要数据表关系如下：

- teachers表：存储教师信息
- classes表：存储班级信息，通过teacher_id关联到teachers表
- class_students表：班级学生关联表，关联classes和学生表
- exams表：存储试卷信息，通过teacher_id关联到teachers表
- questions表：存储题目信息，通过exam_id关联到exams表
- latex_questions表：存储LaTeX题目信息

## 6、系统出错处理 

### 6.1、出错信息
| 错误类型 | 错误代码 | 错误信息 | 处理方式 |
| -------- | -------- | -------- | -------- |
| 认证错误 | 401 | "未授权：无效的令牌" | 返回401状态码和错误信息 |
| 权限错误 | 403 | "禁止：无权访问此资源" | 返回403状态码和错误信息 |
| 资源不存在 | 404 | "未找到：请求的资源不存在" | 返回404状态码和错误信息 |
| 请求无效 | 400 | "请求无效：缺少必要参数" | 返回400状态码和详细错误说明 |
| 服务器错误 | 500 | "服务器内部错误" | 记录错误日志，返回500状态码 |
| 数据库错误 | 500 | "数据库操作失败" | 记录错误日志，返回500状态码 |

### 6.2、补救措施
- **全局错误处理**：使用Express全局错误处理中间件捕获未处理的异常
- **事务管理**：数据库操作使用事务确保数据一致性
- **错误日志**：详细记录错误信息，便于排查
- **优雅关闭**：进程终止前关闭数据库连接和其他资源
- **请求验证**：使用中间件验证请求数据，及早拦截无效请求

## 7、其他设计

### 7.1、安全设计
- **JWT认证**：使用JWT进行用户身份验证
- **密码加密**：使用bcrypt加密存储用户密码
- **输入验证**：验证和清理所有请求数据
- **CORS设置**：配置跨域资源共享策略，限制未授权来源
- **速率限制**：对敏感API实施速率限制，防止暴力攻击

### 7.2、性能设计
- **数据库连接池**：使用MySQL连接池优化数据库连接管理
- **查询优化**：优化SQL查询，使用适当的索引
- **缓存策略**：缓存不常变化的数据，减少数据库负载
- **异步处理**：利用Node.js异步特性处理IO密集型操作
- **分页处理**：大数据集使用分页返回，减少响应时间和内存使用 